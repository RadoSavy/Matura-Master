<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="robots" content="NOODP">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Matura Master">
  <meta name="google" content="notranslate">
  <meta name="mobile-web-app-capable" content="yes">
  <title>BAI –ì–∞–Ω—å–æ - Matura Master</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .ai-chat-container {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .ai-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .ai-header h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin: 0;
      font-size: 2.5rem;
    }

    .ai-chat-messages {
      height: 400px;
      overflow-y: auto;
      padding: 1.5rem;
      background: #f9f9f9;
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 70%;
      padding: 1rem;
      border-radius: 8px;
      word-wrap: break-word;
    }

    .message.ai .message-content {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }

    .message.user .message-content {
      background: #667eea;
      color: white;
      border-radius: 8px 0 8px 8px;
    }

    .ai-input-area {
      padding: 1.5rem;
      border-top: 1px solid #eee;
      display: flex;
      gap: 0.5rem;
    }

    .ai-input-area input {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
    }

    .ai-input-area button {
      padding: 0.75rem 1.5rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .ai-input-area button:hover {
      background: #764ba2;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }

    .feature-box {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      border: 2px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .feature-box:hover {
      box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }

    .feature-box h3 {
      color: #667eea;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem;
      border-left: 4px solid #c62828;
    }

    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem;
      border-left: 4px solid #2e7d32;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">MM</div>
      <span>Matura Master</span>
    </div>
    <div class="header-actions">
      <button class="profile-btn">–ò</button>
    </div>
  </header>

  <main>
    <div id="message-container"></div>

    <!-- AI Chat Interface -->
    <div class="ai-chat-container">
      <div class="ai-header">
        <h1>ü§ñ BAI –ì–∞–Ω—å–æ</h1>
        <p>–í–∞—à–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–µ–Ω AI –∞—Å–∏—Å—Ç–µ–Ω—Ç –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</p>
      </div>

      <div class="ai-chat-messages" id="chat-messages">
        <div class="message ai">
          <div class="message-content">
            <strong>BAI –ì–∞–Ω—å–æ:</strong> –ó–¥—Ä–∞–≤–µ–π! –ê–∑ —Å—ä–º —Ç–≤–æ–π AI –∞—Å–∏—Å—Ç–µ–Ω—Ç. –°—ä–º —Ç—É–∫ –¥–∞ —Ç–µ –ø–æ–º–æ–≥–Ω–∞ —Å —É—á–µ–Ω–∏–µ—Ç–æ –ø–æ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞. –ó–∞–¥–∞–π –º–∏ –≤—ä–ø—Ä–æ—Å –∏–ª–∏ –∏–∑–±–µ—Ä–∏ –µ–¥–Ω–∞ –æ—Ç –æ–ø—Ü–∏–∏—Ç–µ –æ—Ç–¥–æ–ª—É! üëã
          </div>
        </div>
      </div>

      <div class="ai-input-area">
        <input 
          type="text" 
          id="ai-question" 
          placeholder="–ù–∞–ø–∏—à–∏ —Ç–≤–æ—è –≤—ä–ø—Ä–æ—Å —Ç—É–∫..."
          onkeypress="if(event.key==='Enter') sendMessage()"
        >
        <button onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> –ò–∑–ø—Ä–∞—Ç–∏
        </button>
      </div>
    </div>

    <!-- AI Features -->
    <section style="margin: 3rem auto; max-width: 900px; padding: 0 1rem;">
      <h2 style="text-align: center; color: #667eea;">‚ú® –í—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ BAI –ì–∞–Ω—å–æ</h2>
      
      <div class="features-grid">
        <div class="feature-box" onclick="generateExercises('–≥—Ä–∞–º–∞—Ç–∏–∫–∞', 'easy')">
          <h3><i class="fas fa-tasks"></i> –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
          <p>BAI –ì–∞–Ω—å–æ –º–æ–∂–µ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –∏–∑–±—Ä–∞–Ω –æ—Ç —Ç–µ–± –ø—Ä–µ–¥–º–µ—Ç –∏ –Ω–∏–≤–æ –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –ì–µ–Ω–µ—Ä–∏—Ä–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
          </button>
        </div>

        <div class="feature-box" onclick="getUserRecommendation()">
          <h3><i class="fas fa-lightbulb"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h3>
          <p>–ü–æ–ª—É—á–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏, –∫–æ–∏ —Ç–µ–º–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ –ø—Ä–æ—É—á–∏—à –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ —Ç–≤–æ—è –Ω–∞–ø—Ä–µ–¥—ä–∫.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –í–∏–∂—Ç–µ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏
          </button>
        </div>

        <div class="feature-box" onclick="createStudyPlan()">
          <h3><i class="fas fa-calendar"></i> –£—á–µ–±–µ–Ω –ø–ª–∞–Ω</h3>
          <p>BAI –ì–∞–Ω—å–æ –º–æ–∂–µ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω —É—á–µ–±–µ–Ω –ø–ª–∞–Ω –∑–∞ —Ç–µ–±.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –ù–∞–ø—Ä–∞–≤–∏ –ø–ª–∞–Ω
          </button>
        </div>

        <div class="feature-box" onclick="searchKnowledge()">
          <h3><i class="fas fa-search"></i> –¢—ä—Ä—Å–µ–Ω–µ –≤ –±–∞–∑–∞—Ç–∞ –æ—Ç –∑–Ω–∞–Ω–∏—è</h3>
          <p>–¢—ä—Ä—Å–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –±–∞–∑–∞—Ç–∞ –æ—Ç –∑–Ω–∞–Ω–∏—è –∑–∞ –∏–∑—É—á–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –¢—ä—Ä—Å–∏
          </button>
        </div>

        <div class="feature-box" onclick="generateAssessment()">
          <h3><i class="fas fa-check-square"></i> –¢–µ—Å—Ç / –û—Ü–µ–Ω–∫–∞</h3>
          <p>–ù–∞–ø—Ä–∞–≤–∏ —Ç–µ—Å—Ç, –∑–∞ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—à—å –∑–Ω–∞–Ω–∏—è—Ç–∞ —Å–∏ –ø–æ –Ω—è–∫–æ—è —Ç–µ–º–∞.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –ù–∞–ø—Ä–∞–≤–∏ —Ç–µ—Å—Ç
          </button>
        </div>

        <div class="feature-box" onclick="getNextLesson()">
          <h3><i class="fas fa-arrow-right"></i> –°–ª–µ–¥–≤–∞—â —É—Ä–æ–∫</h3>
          <p>BAI –ì–∞–Ω—å–æ –ø—Ä–µ–¥–ª–∞–≥–∞ —Å–ª–µ–¥–≤–∞—â–∏—è —É—Ä–æ–∫ –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ —Ç–≤–æ—è –Ω–∞–ø—Ä–µ–¥—ä–∫.</p>
          <button style="width: 100%; padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            –í–∏–∂–¥–∞–º–µ —Å–ª–µ–¥–≤–∞—â–∏—è —É—Ä–æ–∫
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Load Firestore Integration Module -->
  <script src="/scripts/firestore-integration.js"></script>

  <script>
    // Initialize Firestore Integration
    const fs = new FirestoreIntegration('http://localhost:5000/api');
    const currentUserId = localStorage.getItem('userId') || 'demo-user';

    // Send message to AI
    async function sendMessage() {
      const question = document.getElementById('ai-question').value.trim();
      if (!question) return;

      // Add user message to chat
      addMessageToChat('user', question);
      document.getElementById('ai-question').value = '';

      try {
        // Show loading indicator
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai';
        messageDiv.innerHTML = '<div class="message-content"><span class="loading-spinner"></span> –ú–∏—Å–ª–∞–º...</div>';
        document.getElementById('chat-messages').appendChild(messageDiv);

        const response = await fs.askAI(question);
        
        // Remove loading message
        messageDiv.remove();

        if (response.status === 'success' || response.status === 'partial') {
          let fullResponse = response.answer;
          if (response.explanation) {
            fullResponse += `\n\nüìå ${response.explanation}`;
          }
          addMessageToChat('ai', fullResponse);
        } else {
          addMessageToChat('ai', '–ò–∑–≤–∏–Ω—è–≤–∞–º —Å–µ, –Ω–µ –º–æ–≥–∞ –¥–∞ –æ—Ç–≥–æ–≤–æ—Ä—è –Ω–∞ —Ç–æ–∑–∏ –≤—ä–ø—Ä–æ—Å. –û–ø–∏—Ç–∞–π —Å –¥—Ä—É–≥.');
        }
      } catch (error) {
        console.error('Error:', error);
        addMessageToChat('ai', '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—â—É–≤–∞–Ω–µ—Ç–æ. –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.');
      }

      // Scroll to bottom
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    // Add message to chat display
    function addMessageToChat(sender, message) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      messageDiv.innerHTML = `<div class="message-content">${sender === 'user' ? '' : '<strong>BAI –ì–∞–Ω—å–æ:</strong> '} ${escapeHtml(message)}</div>`;
      chatMessages.appendChild(messageDiv);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show message
    function showMessage(message, type = 'info') {
      const container = document.getElementById('message-container');
      const messageClass = type === 'error' ? 'error-message' : 'success-message';
      container.innerHTML = `<div class="${messageClass}">${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    // Generate Exercises
    async function generateExercises(topic, difficulty) {
      addMessageToChat('ai', `–ì–µ–Ω–µ—Ä–∏—Ä–∞–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ "${topic}" —Å –Ω–∏–≤–æ –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç "${difficulty}"...`);
      try {
        const result = await fs.generateExercises(topic, difficulty, 3);
        if (result.exercises && result.exercises.length > 0) {
          let response = `–ì–µ–Ω–µ—Ä–∏—Ä–∞—Ö ${result.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:\n\n`;
          result.exercises.forEach((ex, i) => {
            response += `${i+1}. ${ex.question || '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'}\n`;
          });
          addMessageToChat('ai', response);
        }
      } catch (error) {
        addMessageToChat('ai', '–ù–µ –º–æ–≥–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.');
      }
    }

    // Get User Recommendation
    async function getUserRecommendation() {
      addMessageToChat('ai', '–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º —Ç–≤–æ—è –Ω–∞–ø—Ä–µ–¥—ä–∫...');
      try {
        const userProgress = {
          weak_areas: ['grammar'],
          completed_lessons: 3
        };
        const result = await fs.getRecommendation(userProgress);
        if (result.recommendations) {
          let response = 'üìö –ú–æ–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏:\n\n';
          result.recommendations.forEach(rec => {
            response += `‚Ä¢ ${rec}\n`;
          });
          if (result.next_topic) {
            response += `\nüìå –°–ª–µ–¥–≤–∞—â–∞—Ç–∞ —Ç–µ–º–∞: ${result.next_topic}`;
          }
          addMessageToChat('ai', response);
        }
      } catch (error) {
        addMessageToChat('ai', '–ù–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–º–µ—Ä—è –ø—Ä–µ–ø–æ—Ä—ä–∫–∏.');
      }
    }

    // Create Study Plan
    async function createStudyPlan() {
      addMessageToChat('ai', '–ü—Ä–∞–≤—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω —É—á–µ–±–µ–Ω –ø–ª–∞–Ω...');
      try {
        const result = await fs.createStudyPlan(currentUserId, ['–≥—Ä–∞–º–∞—Ç–∏–∫–∞', '–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞'], 4);
        let response = 'üìÖ –¢–≤–æ–π —É—á–µ–±–µ–Ω –ø–ª–∞–Ω (4 —Å–µ–¥–º–∏—Ü–∏):\n\n';
        if (result.weekly_goals) {
          result.weekly_goals.forEach(goal => {
            response += `–°–µ–¥–º–∏—Ü–∞ ${goal.week}: ${goal.goal}\n`;
          });
        }
        addMessageToChat('ai', response);
      } catch (error) {
        addMessageToChat('ai', '–ù–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤—è –ø–ª–∞–Ω.');
      }
    }

    // Search Knowledge
    async function searchKnowledge() {
      const query = prompt('–ö–∞–∫–≤–æ –∏—Å–∫–∞—à –¥–∞ —Ç—ä—Ä—Å–∏—à?');
      if (!query) return;
      
      addMessageToChat('ai', `–¢—ä—Ä—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ "${query}"...`);
      try {
        const result = await fs.searchKnowledge(query);
        if (result.results && result.results.length > 0) {
          let response = `–ù–∞–º–µ—Ä–∏—Ö ${result.results.length} —Ä–µ–∑—É–ª—Ç–∞—Ç–∞:\n\n`;
          result.results.slice(0, 3).forEach((res, i) => {
            response += `${i+1}. ${res.topic}: ${JSON.stringify(res.data).substring(0, 100)}...\n`;
          });
          addMessageToChat('ai', response);
        } else {
          addMessageToChat('ai', '–ù–µ –Ω–∞–º–µ—Ä–∏—Ö —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ —Ç–≤–æ—è—Ç–∞ –∑–∞—è–≤–∫–∞.');
        }
      } catch (error) {
        addMessageToChat('ai', '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ.');
      }
    }

    // Generate Assessment
    async function generateAssessment() {
      const topic = prompt('–ü–æ –∫–∞–∫–≤–∞ —Ç–µ–º–∞ –∏—Å–∫–∞—à —Ç–µ—Å—Ç?') || '–≥—Ä–∞–º–∞—Ç–∏–∫–∞';
      addMessageToChat('ai', `–ì–µ–Ω–µ—Ä–∏—Ä–∞–º —Ç–µ—Å—Ç –ø–æ "${topic}"...`);
      try {
        const result = await fs.generateAssessment(topic, 5);
        let response = `‚úÖ –¢–µ—Å—Ç –ø–æ "${topic}" (${result.total_questions} –≤—ä–ø—Ä–æ—Å–∏)\n\n`;
        response += `–í—Ä–µ–º–µ: ${result.time_limit_minutes} –º–∏–Ω—É—Ç–∏\n`;
        response += `–ü—Ä–æ—Ö–æ–¥–Ω–∞ –æ—Ü–µ–Ω–∫–∞: ${result.passing_score}%\n\n`;
        if (result.exercises) {
          result.exercises.slice(0, 2).forEach((ex, i) => {
            response += `${i+1}. ${ex.question}\n`;
          });
          response += `\n... –∏ –æ—â–µ ${Math.max(0, result.exercises.length - 2)} –≤—ä–ø—Ä–æ—Å–∞`;
        }
        addMessageToChat('ai', response);
      } catch (error) {
        addMessageToChat('ai', '–ù–µ –º–æ–≥–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º —Ç–µ—Å—Ç.');
      }
    }

    // Get Next Lesson
    async function getNextLesson() {
      addMessageToChat('ai', '–ù–∞–º–∏—Ä–∞–º —Å–ª–µ–¥–≤–∞—â–∏—è —É—Ä–æ–∫ –∑–∞ —Ç–µ–±...');
      try {
        const result = await fs.getNextLesson(currentUserId, {});
        let response = `üìñ –°–ª–µ–¥–≤–∞—â–∏ —É—Ä–æ–∫:\n\n`;
        response += `–¢–µ–º–∞: ${result.next_lesson}\n`;
        response += `–ü—Ä–∏—á–∏–Ω–∞: ${result.reason}\n`;
        response += `–ù–∏–≤–æ: ${result.difficulty}\n`;
        response += `–í—Ä–µ–º–µ: ${result.estimated_duration_minutes} –º–∏–Ω—É—Ç–∏`;
        addMessageToChat('ai', response);
      } catch (error) {
        addMessageToChat('ai', '–ù–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–º–µ—Ä—è —Å–ª–µ–¥–≤–∞—â–∏—è —É—Ä–æ–∫.');
      }
    }
  </script>
</body>
</html>
