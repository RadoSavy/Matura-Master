document.addEventListener('DOMContentLoaded', function () {
  const chat = document.getElementById('chat');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const quickQuestions = document.querySelectorAll('.quick-question');

  const knowledgeBase = {
    "частици": {
        answer: "Частиците в българския език са:\n1. Отрицателни (не, ни)\n2. Възклицателни (ех, ох, ах)\n3. Утвердителни (да, ами)\n4. Съединителни (и, а, но, че)\n5. Въпросителни (ли, дали, защо)",
        examples: ["Не искам да отида.", "Ех, колко хубаво!", "Ще дойдеш ли утре?"]
    },
    "правопис на не и ни": {
        answer: "Правопис на 'не' и 'ни':\n- 'Не' се пише отделно с глаголи: не искам, не чета\n- 'Не' се пише слитно с прилагателни и наречия: неинтересен, невнимателно\n- 'Ни' се използва за усилване на отрицание: нито идвам, нито пиша\nИзключения:\n- Когато има противопоставяне: 'не висок, а нисък'\n- При повторение: 'нито риба, нито месо'",
        examples: ["Не мога да дойда.", "Нито ми се яде, нито ми се спи."],
        rules: ["Не + глагол = отделно", "Не + прилагателно/наречие = слитно"]
    },
    "ъ и ь": {
        answer: "Правопис на 'ъ' и 'ь':\n1. 'Ъ' се пише:\n- След префикс пред 'я', 'ю': съюз, обезъязвим\n- В корена на думите: ъгъл, мъка\n2. 'Ь' се пише:\n- Между съгласна и 'о': шьов, жьол\n- В някои чужди думи: бульон",
        examples: ["съжалявам", "обезъяна", "шьол"]
    },
    "морфеми": {
        answer: "Морфемите са най-малките значими части на думата:\n1. Корен - носи основното значение\n2. Префикс - пред корена\n3. Суфикс - след корена\n4. Окончание - променя се според граматичните правила",
        examples: ["под-вод-н-и", "пре-пиш-вам"]
    },
    "глаголни времена": {
        answer: "Глаголни времена в българския език:\n1. Сегашно: чета, пишеш\n2. Минало несвършено: четях, пишеше\n3. Минало свършено: прочетох, написа\n4. Минало неопределено: съм чел, съм писал\n5. Минало предварително: бях чел, беше писал\n6. Бъдеще: ще чета, ще пиша\n7. Бъдеще в миналото: щях да чета\n8. Бъдеще предварително: ще съм чел",
        examples: ["Той четяше (минало несвършено)", "Той е чел (минало неопределено)", "Той щеше да чете (бъдеще в миналото)"],
        rules: ["Минало свършено за 1 л. ед.ч. завършва на -х: писах"]
    },
    "съществително име": {
        answer: "Съществителното име:\n- Назовава хора, животни, предмети, понятия\n- Има род (мъжки, женски, среден)\n- Има число (единствено и множествено)\n- Склонява се (променя се по падежи)",
        examples: ["мъжки род: ученик", "женски род: учителка", "среден род: дете"]
    },
    "прилагателно име": {
        answer: "Прилагателното име:\n- Означава качество или признак на предмет\n- Съгласува се по род, число и падеж със съществителното\n- Степенува се: положителна, сравнителна, превъзходна",
        examples: ["хубав", "по-хубав", "най-хубав"]
    },
    "числително име": {
        answer: "Числителното име:\n- Означава брой, ред или количество\n- Видове: бройни (едно, две), редни (първи, втори), дробни (половин, една трета)",
        examples: ["пет ученика", "втори клас", "половин ябълка"]
    },
    "местоимения": {
        answer: "Видове местоимения:\n1. Лични: аз, ти, той, тя, то, ние, вие, те\n2. Възвратни: себе си\n3. Притежателни: мой, твой, негов\n4. Въпросителни: кой, какъв, чий\n5. Относителни: който, какъвто\n6. Неопределителни: някой, нещо\n7. Отрицателни: никой, нищо",
        rules: ["Местоименията заместват имена"]
    },
    "глагол": {
        answer: "Глаголът:\n- Означава действие или състояние\n- Има вид (свършен и несвършен)\n- Има време (сегашно, минало, бъдеще)\n- Има наклонение (изявително, повелително, условно)",
        examples: ["чета (несвършен вид)", "прочета (свършен вид)"]
    },
    "причастия": {
        answer: "Видове причастия:\n1. Сегашно деятелно: четящ, пишещ\n2. Минало деятелно: чел, писал\n3. Минало страдателно: четен, писан\n4. Деепричастие: четейки, пишейки\nПравила:\n- Сегашните причастия се образуват с -щ/-ящ\n- Миналото деятелно причастие се образува с -л\n- Миналото страдателно причастие се образува с -н/-т",
        examples: ["Четейки книгата (деепричастие)", "Прочетената книга (минало страдателно)"]
    },
    "наречие": {
        answer: "Наречието:\n- Означава признак на действие, качество или друг признак\n- Видове: начин (бързо, хубаво), място (тук, там), време (сега, тогава), количество (много, малко)",
        examples: ["Той бързо тича.", "Тя пее хубаво."]
    },
    "предлог": {
        answer: "Предлозите:\n- Изразяват отношение между думите в изречението\n- Видове: прост (в, на, за, с) и съставен (въпреки, заради)",
        examples: ["Отивам на училище.", "Вървя с приятел."]
    },
    "съюз": {
        answer: "Съюзите:\n- Свързват думи или изречения\n- Видове: съчинителни (и, а, но, че) и подчинителни (че, защото, ако)",
        examples: ["Искам да чета и да пиша.", "Отивам, защото трябва."]
    },
    "частица": {
        answer: "Частиците:\n- Придават допълнителни нюанси на изречението\n- Видове: възклицателни (ех, ох), отрицателни (не), утвердителни (да)",
        examples: ["Ох, колко боли!", "Не искам да отида."]
    },
    "междуметие": {
        answer: "Междуметията:\n- Изразяват чувства или подражават на звуци\n- Видове: емоционални (ах, ура), звукоподражателни (мряу, бум)",
        examples: ["Ура, утре е уикенд!", "Кучето прави бау-бау."]
    },
    "описание": {
        answer: "Описание:\n- Представя предмети, хора, места или явления\n- Използва много прилагателни и наречия\n- Може да бъде: предметно, пейзажно, портретно, динамично",
        examples: ["Описание на природа", "Описание на човек"]
    },
    "повествование": {
        answer: "Повествование:\n- Разказва за събития или действия\n- Има начало, развитие и край\n- Често се използва в приказки, разкази, романи",
        rules: ["Хронологичен ред на събитията", "Главни герои", "Кулминация"]
    },
    "разсъждение": {
        answer: "Разсъждение:\n- Излага мнение, идеи или твърдения\n- Съдържа теза, аргументи и заключение\n- Използва се в есета, статии, дискусии",
        examples: ["Разсъждение на тема 'Защо трябва да четем'"]
    },
    "изречение": {
        answer: "Части на изречението:\n1. Подлог - кой/какво извършва действието\n2. Сказуемо - какво прави подлогът\n3. Допълнение - обект на действието\n4. Определение - пояснява подлог или допълнение\n5. Обстоятелствено пояснение - място, време, начин",
        examples: ["Ученикът (подлог) чете (сказуемо) книга (допълнение) внимателно (обст. пояснение)"]
    },
    "сложни изречения": {
        answer: "Видове сложни изречения:\n1. Сложносъчинени - съставени от равноправни части (съюзи: и, а, но, ами, или)\n2. Сложноподчинени - има главно и подчинено изречение (съюзи: че, когато, ако, защото, тъй като)\n3. Сложносъставни - комбинация от съчинени и подчинени части\n4. Безсъюзни - частите се разделят със запетая, точка и запетая или двоеточие",
        examples: ["Четях книга, а той гледаше телевизия (съчинено).", "Като влезе в стаята, всички млъкнаха (подчинено)."],
        rules: ["Подчинените изречения винаги се отделят със запетая"]
    },
    "чужда реч": {
        answer: "Начини за предаване на чужда реч:\n1. Пряка реч: \"Ще дойда утре\", каза той.\n2. Непряка реч: Той каза, че ще дойде утре.\n3. Полупряка реч: Той ще дойде утре, каза си.",
        rules: ["Пряката реч се поставя в кавички"]
    },
    "една българка": {
        answer: "Разказ 'Една българка' от Иван Вазов:\n- Героиня: баба Илийца, която пътува до манастира за помощ за болния си син\n- Среща калугера Евтимий, който ѝ помага\n- Теми: майчина любов, вяра, човечност, съпричастност",
        quotes: ["„Бог да го прости, че не ме позна!“"],
        themes: ["Майчина жертва", "Човечност", "Вяра"]
    },
    "по жътва": {
        answer: "Разказ 'По жътва' от Йордан Йовков:\n- Действие по време на жътва\n- Героиня: Пенка, която пее и утешава жътварите\n- Теми: сила на музиката, български фолклор, колективен труд",
        examples: ["Песента на Пенка прави труда по-лек"],
        themes: ["Фолклор", "Колективност", "Сила на изкуството"]
    },
    "серафим": {
        answer: "Разказ 'Серафим' от Йордан Йовков:\n- Герой: беден човек със златно сърце\n- Дарява последните си пари за лечение на непозната\n- Теми: състрадание, човечност, безкористност",
        quotes: ["„Какво съм направил! Никому нищо не съм направил...“"],
        themes: ["Доброта", "Саможертва", "Човечност"]
    },
    "опълченците на шипка": {
        answer: "Стихотворение 'Опълченците на Шипка' от Иван Вазов:\n- Възпява героизма на българските опълченци\n- Ключови символи: Шипка, Балкан, свобода\n- Художествени средства: алегория, метафора, хипербола",
        quotes: ["„Едно име ново, голямо, антично, като Термопили славно, безгранично!“"],
        themes: ["Патриотизъм", "Жертвоготовност", "Историческа памет"]
    },
    "по жицата": {
        answer: "Разказ 'По жицата' от Йордан Йовков:\n- Герои: Моканина, Негованка\n- Конфликт: любов срещу социални норми\n- Теми: невъзможна любов, социална несправедливост, спомен",
        examples: ["Трагичната смърт на героинята при жътва"],
        themes: ["Невъзможна любов", "Патриархално общество", "Трагедия"]
    },
    "неразделни": {
        answer: "Балада 'Неразделни' от Пенчо Слажейков:\n- Трагична любовна история\n- Символи: стройна Калина, кичест Явор\n- Теми: вечна любов, жертва, неразделност",
        quotes: ["„Калино, Калино, стройна Калино, защо си на сърце рана?"],
        themes: ["Вечна любов", "Жертва", "Невъзможност за разделяне"]
    },
    "до чикаго и назад": {
        answer: "Пътеписи 'До Чикаго и назад' от Алеко Константинов:\n- Културен шок на българина в чужбина\n- Характерни сцени: скандалът с килима във Виена",
        examples: ["„Какво ще ѝ гледам на Виената, град като град: хора, къщи, салтанати“"],
        themes: ["Национална идентичност", "Културни различия", "Комични ситуации"]
    },
    "заточеници": {
        answer: "Стихотворение 'Заточеници' от Иван Вазов:\n- Описва страданията на българските революционери в заточение\n- Теми: страдание, надежда, патриотизъм\n- Художествени средства: метафора, епитет, хипербола",
        quotes: ["„В мрачния зиндан, в подземия студен, където мрак и страх царуват вечно...“"]
    },
    "вятър ечи, балкан стене": {
        answer: "Песен 'Вятър ечи, Балкан стене' от Христо Ботев:\n- Възпява хайдушкия живот и борбата за свобода\n- Теми: свобода, жертва, природа\n- Строфи: 4 стиха, рима aabb",
        quotes: ["„Вятър ечи, Балкан стене, люшка се гора зелена...“"]
    },
    "под игото": {
        answer: "Основни теми в 'Под игото' на Иван Вазов:\n1. Борба за национално освобождение\n2. Любов към родината\n3. Животът по време на османското владичество\n4. Човешките взаимоотношения в трудни времена\nГлавни герои: Бойчо Огнянов, Рада, дядо Йоцо",
        quotes: ["Който падне в бой за свобода, той не умира!"]
    },
    "немили-недраги": {
        answer: "Герои в 'Немили-недраги' на Иван Вазов:\n1. Македонски – смел и буен хъш. Обича битките, но е и емоционален. Представлява борбения дух на българския революционер.\n2. Бръчков – Бръчков е млад, наивен, но идеалистичен хъш. Първо се възхищава на хъшовете, но после осъзнава трудната им съдба. Символ е на новото поколение и надеждата за бъдещето. Помага на Странджата в последните му мигове.\n3. Странджата – Странджата е болен и възрастен хъш, бивш знаменосец. Държи кръчма в Браила и помага на другите хъшове. Символ е на патриотизъм и саможертва. Умира, без да види свободна България.\n4. Хаджият – млад човек, но преждевременно състарен от тежката емигрантска участ. Хаджият е един  от посетителите на кръчмата на Знаменосеца, който също слуша разказите и спомените на своите другари.\nОсновен конфликт: саможертвата и трудностите на емигрантския живот в името на свободата на България.",
        themes: ["Патриотизъм", "Саможертва", "Борба за национално освобождение", "Емигрантски живот"]
    },
    "народни песни": {
        answer: "Видове български народни песни:\n1. Юнашки песни - за исторически събития\n2. Обичайни песни - за празници\n3. Любовни песни - за човешки чувства\n4. Трудови песни - свързани с занаяти",
        examples: ["Край Вардара вее се бяло знаме"]
    },
    "хайдути": {
        answer: "Поема 'Хайдути' на Христо Ботев:\n- Възпява хайдушкия живот и борбата срещу османското владичество\n- Главен герой: Димитър (Димо) хайдутин\n- Основна тема: свободата и готовността да се жертваш за нея",
        quotes: ["Какви е деца раждала българка майка юнашка!"]
    },
    "бай ганьо": {
        answer: "Бай Ганьо - герой на Алеко Константинов:\n- Типичен български образ с добри и лоши черти\n- Показва недостатъците на българското общество\n- Често е невеж, егоистичен, но и симпатичен",
        examples: ["Бай Ганьо пътува из Европа и прави гафове"]
    },
    "езикът на възрожденците": {
        answer: "Характерни черти на възрожденската литература:\n1. Патриотизъм и национална идея\n2. Реалистично описание на живота\n3. Обществени и нравствени теми\n4. Употреба на народен език\nПредставители: Вазов, Ботев, Каравелов",
        examples: ["Под игото", "Хайдути", "Епоха на Българското възраждане"]
    },
    "приказки": {
        answer: "Характеристики на приказките:\n1. Неопределено време и място\n2. Чудотворни елементи\n3. Доброто побеждава злото\n4. Поучителен характер\nВидове: животнински, волшебни, битови",
        examples: ["Котаракът в чизми", "Грозното патенце", "Червената шапчица"]
    },
    "стихотворни размери": {
        answer: "Основни стихотворни размери:\n1. Ямбо: ударение на втората сричка (пример: \"Там в планината висока\")\n2. Хорей: ударение на първата сричка (пример: \"Бързай, бързай, момче младо\")\n3. Дактил: ударение на първата от три срички (пример: \"Тъжно, тъжно, мили друже\")\n4. Амфибрахий: ударение на втората от три срички (пример: \"По синьо небе луна плува\")",
        rules: ["Стихотворният размер определя ритъма на стиха"]
    },
    "анализ на стихотворение": {
        answer: "Стъпки при анализ на стихотворение:\n1. Тема и основна мисъл\n2. Лирически герой\n3. Композиция (строфи, рими)\n4. Стихотворен размер\n5. Художествени средства (метафори, сравнения)\n6. Емоционално въздействие",
        examples: ["Анализ на \"Моята молитва\" от Христо Ботев"]
    },
    "епически произведения": {
        answer: "Характеристики на епическите произведения:\n1. Разказва за събития и герои\n2. Има разказвач (повествовател)\n3. Включва описания и диалози\n4. Обемни творби (повести, романи)\nЖанрове: роман, повест, разказ, епос",
        examples: ["Под игото", "Железният светилник", "Тютюн"]
    },
    "драматични произведения": {
        answer: "Характеристики на драматичните произведения:\n1. Предназначени за поставяне на сцена\n2. Състоят се от диалози и реплики\n3. Разделение на действия и сцени\n4. Сценични указания\nЖанрове: трагедия, комедия, драма",
        examples: ["Госпожа Министершата", "Свекърва", "Хан Аспарух"]
    },
    "лирически произведения": {
        answer: "Характеристики на лирическите произведения:\n1. Изразяват чувства и преживявания\n2. Кратки форми (стихотворения, поеми)\n3. Използват поетични фигури\n4. Силен емоционален заряд\nВидове: медитативна, пейзажна, философска лирика",
        examples: ["Моята молитва", "На прощаване", "Елегия"]
    },
    "преразказ": {
        answer: "Видове преразказ за матура:\n1. Подробен - запазва всички детайли\n2. Подборен - фокус върху ключови моменти\n3. Трансформиращ - промяна на гледна точка\nПравила:\n- Запазване на основната идея\n- Последователност на събитията\n- Обем: 15-20 изречения\n- Употреба на собствени думи",
        examples: ["Преразказ на разказа 'Талисманът' от Красимир Бачков"]
    },
    "анотация": {
        answer: "Анотацията:\n- Кратко представяне на съдържанието на книга или статия\n- Структура: автор, заглавие, основна тема, основни герои/идеи, препоръка\n- Обем: 5-10 изречения\n- Цел: да информира и заинтригува читателя",
        examples: ["Анотация за романа 'Под игото'"]
    },
    "интервю": {
        answer: "Интервюто:\n- Разговор между журналист и интервюиран\n- Цел: събиране на информация или лични мнения\n- Структура: въведение, основни въпроси, заключение\n- Правила: подготвени въпроси, активен слушател, уважение",
        examples: ["Интервю с известен писател"]
    },
    "матура съвети": {
        answer: "Стратегии за успешна матура:\n1. Времеразпределение:\n   - Четене с разбиране: 30-40 мин\n   - Граматика: 20-30 мин\n   - Литература: 30-40 мин\n   - Писане: 40-50 мин\n2. Четене с разбиране:\n   - Два пъти прочитане на текста\n   - Подчертаване на ключови думи\n3. Граматика:\n   - Проверка на правопис\n   - Анализ на изреченията\n4. Литература:\n   - Цитиране на точни примери\n   - Анализ на теми и герои\n5. Писане:\n   - Планиране преди писането\n   - Проверка на граматиката след писането",
        rules: ["Не пропускай нито една задача", "Провери си отговорите преди предаване"]
    },
    "репортаж": {
        answer: "Репортажът:\n- Жанр в журналистиката, който описва събитие на място\n- Елементи: факти, описания, директна реч на участници\n- Структура: привличащо внимание начало, описание на събитието, заключение\n- Цел: да информира и заинтригува читателя",
        themes: ["Репортаж от училищен празник"]
    },
    "масова комуникация": {
        answer: "Масовата комуникация достига до огромна аудитория чрез медии: интернет, ТВ, радио, вестници. Характеристики:\n• Широка аудитория\n• Медиен посредник\n• Публичност\n• Информативност\nВидове медийни текстове:\n• Информационна бележка\n• Репортаж\n• Интервю",
        examples: ["Новини", "Репортажи", "Интервюта"],
        rules: ["Фактичност", "Актуалност", "Обективност"]
    },
    "информационна бележка": {
        answer: "Информационната бележка е кратък медиен текст с:\n• Фактичност\n• Краткост\n• Актуалност\n• Обективност\n• Отговори на въпросите: Какво? Къде? Кога?\n• Без коментари и оценки",
        examples: ["Новина за спортно събитие", "Съобщение за обществено събитие", "Кратко съобщение за ново откритие"],
        rules: ["Без коментари", "Ясни факти", "Кратък формат", "Обективност"]
    },
    "репортаж детайли": {
        answer: "Репортажът е авторски разказ за събитие с:\n• Актуалност\n• Образност\n• Емоционалност\n• Факти + лична оценка\n• Описание от място\n• Атмосфера и детайли\n• Авторска гледна точка",
        examples: ["Спортен репортаж", "Репортаж от протест", "Репортаж от празник", "Репортаж от изложба"],
        rules: ["Комбинира факти и авторски впечатления", "Създава атмосфера", "Включва директна реч", "Описва от първо лице"]
    },
    "интервю техники": {
        answer: "Интервюто е диалогична форма между:\n• Интервюиращ (задава въпроси)\n• Интервюиран (отговаря)\nВидове въпроси:\n• Фактически - за конкретни факти\n• Портретни - за личността и характера\n• Бъдещи - за планове и мечти\n• Мнения - за лични възгледи\n• Ситуационни - как би постъпил в дадена ситуация",
        examples: ["Интервю с политик", "Интервю с артист", "Интервю с учен", "Интервю с спортист"],
        rules: ["Подготвени въпроси", "Активно слушане", "Уважение към събеседника", "Следване на темата", "Записване на отговорите"]
    },
    "художествен текст елементи": {
        answer: "Художественият текст създава образи и емоции чрез:\n• Образност (метафори, сравнения, символи)\n• Емоционалност\n• Идеи и послания\n• Стил и авторски глас\n• Художествени средства\n• Сюжет и композиция\n• Герои и характери",
        examples: ["Романи", "Разкази", "Поезия", "Драми", "Новели"],
        rules: ["Създава художествени светове", "Предизвиква емоции", "Носи универсални теми", "Използва художествени средства", "Има естетическа функция"]
    },
    "лексикални средства": {
        answer: "Думата като лексикално средство има:\n• Лексикално значение (смисъл)\n• Граматично значение (род, число, време)\n• Стилистична принадлежност\nФункции:\n• Информативна - предава факти\n• Емоционална - изразява чувства\n• Естетическа - създава красота\n• Въздействаща - влияе на читателя",
        examples: ["Синоними", "Антоними", "Експресивна лексика", "Неутрална лексика", "Терминологична лексика"],
        rules: ["Точна употреба в контекст", "Избор на подходящи думи", "Съответствие на стила", "Богатство на речника"]
    },
    "звукови промени": {
        answer: "Звукови промени в българския език:\n• Подвижно ъ (връв, глътч) - появява се в едносрични думи\n• Непостоянно ъ (тигър → тигърче) - сменя се в различни форми\n• Променливо я (мляко → млекар) - замества се с а, ъ, о, у\n• Огласяване - беззвучен става звучен пред звучен (ориз → орис)\n• Оглушаване - звучен става беззвучен пред беззвучен (лавка → лафка)",
        examples: ["ориз → орис", "лавка → лафка", "пяха → вървяха", "мляко → млекар", "тигър → тигърче"],
        rules: ["Зависи от съседни звукове", "Влияе на произношението", "Свързано с ударението", "Характерно за българския език"]
    },
    "глаголни наклонения": {
        answer: "Три вида глаголни наклонения:\n1. Изявително - реално действие (чета, пишеш)\n2. Условно - възможно действие (бих чел, бихте писали)\n3. Повелително - заповед/молба (чети! четете!)\nОбразуване:\n• Изявително - основни глаголни форми\n• Условно - бих + минало свършено деятелно причастие\n• Повелително - прости форми или с частици да/нека",
        examples: ["Чета (изявително)", "Бих чел (условно)", "Чети! (повелително)", "Да четеш! (повелително)", "Нека чете! (повелително)"],
        rules: ["Показва отношението към действието", "Определя намерението на говорещия", "Зависи от контекста на изречението"]
    },
    "преизказни форми": {
        answer: "Преизказни глаголни форми:\n• Изразяват чуто, не видяно\n• Често с емоционален оттенък (учудване, съмнение, ирония)\n• Пропускат 'съм' в 3-то лице\n• Използват се в народни приказки, исторически съчинения\n• Предават чужди разкази и слухове\n• Могат да изразяват несигурност",
        examples: ["Ходел бил", "Щели да дойдат", "Казал бил", "Бил видял", "Искали да отидат"],
        rules: ["За предаване на чужди думи", "Изразяване на съмнение или учудване", "Често в минало време", "Характерно за устна реч"]
    },
    "глаголни времена система": {
        answer: "Пълна система на глаголните времена в българския език:\n• Сегашно време (чета, пишеш)\n• Минало несвършено (четях, пишеше)\n• Минало свършено (прочетох, написа)\n• Минало неопределено (съм чел, съм писал)\n• Минало предварително (бях чел, беше писал)\n• Бъдеще време (ще чета, ще пиша)\n• Бъдеще предварително (ще съм чел, ще съм писал)\n• Бъдеще време в миналото (щях да чета, щеше да пише)",
        examples: ["четах (минало несвършено)", "прочетох (минало свършено)", "бях чел (минало предварително)", "ще чета (бъдеще)", "ще съм чел (бъдеще предварително)", "щях да чета (бъдеще в миналото)"],
        rules: ["Позиционират действието във времето", "Показват последователност на действията", "Определят завършеност/незавършеност", "Свързани с глаголния вид"]
    },
    "съставно сказуемо": {
        answer: "Видове съставно сказуемо:\n1. Именно сказуемо: глагол 'съм' + именна част (съществително, прилагателно, числително)\n2. Глаголно сказуемо: два глагола с 'да' (първия носи допълнително значение)\nПравила:\n• Именната част се членува пълно в м.р., ед.ч.\n• В учтива форма - ед.ч. за именната част\n• Глаголното сказуемо изразява начало, продължителност, възможност, необходимост",
        examples: ["Той е учител (именно)", "Започвам да чета (глаголно)", "Тя изглежда щастлива (именно)", "Мога да пея (глаголно)", "Трябва да уча (глаголно)"],
        rules: ["Именната част се членува пълно", "В учтива форма - ед.ч. за именната част", "Глаголите се съгласуват по лице и число"]
    },
    "обособени части": {
        answer: "Обособени части в изречението:\n• Определение - характеризира съществително\n• Обстоятелствено пояснение - време, място, начин, причина, цел\nОтделят се със запетая или тире\nМогат да бъдат:\n• Разширени\n• Неразширени\n• Единни или множество",
        examples: ["Дървото, окапало от листата, стоеше (определение)", "Тичаше, уплашено от кучето (обст. пояснение)", "Светлокосо, момчето се смееше (определение)", "Утре, ще дойда (обст. пояснение)"],
        rules: ["Отделят се със запетая", "Дават допълнителна информация", "Могат да стоят в началото, средата или края на изречението", "Подчертават характеристика или обстоятелство"]
    },
    "сложни изречения типове": {
        answer: "Подробна класификация на сложните изречения:\n• Съчинени - равноправни части (съюзи: и, а, но, ами, или)\n• Подчинени - главно + подчинено (съюзи: че, когато, ако, защото, тъй като)\n• Смесени - комбинация от съчинени и подчинени\n• Безсъюзни - разделени със запетая, точка и запетая, двоеточие\nСловоред:\n• Подчинено след главното\n• Подчинено предхожда главното\n• Подчинено вмъкнато в главното",
        examples: ["Четях книга, а той гледаше ТВ (съчинено)", "Като влезе, всички млъкнаха (подчинено)", "Реших, че ще му кажа, ако ми обещае (смесено)", "Влезе, всички млъкнаха (безсъюзно)"],
        rules: ["Подчинените се отделят със запетая", "Словоредът зависи от смисъла", "Съюзите определят вида на връзката"]
    },
    "чужда реч форми": {
        answer: "Начини за предаване на чужда реч:\n• Пряка реч - дословно, с кавички: \"Ще дойда\", каза той\n• Непряка реч - по смисъл, с 'че': Той каза, че ще дойде\n• Полупряка реч - мисли на герой: Чудеше се защо са тъжни\n• Цитат - буквално предаване на чужди думи\nПунктуация:\n• Пряка реч - кавички и тире\n• Непряка реч - съюз 'че' или 'дали'\n• Полупряка реч - без кавички, с авторски глагол",
        examples: ['- "Ще дойда", каза той (пряка)', 'Той каза, че ще дойде (непряка)', 'Чудеше се защо са тъжни (полупряка)', '„Мисля, следователно съществувам" (цитат)'],
        rules: ["Пряката реч се отделя с кавички", "Полупряката комбинира експресивност и граматика", "Непряката се образува с подчинителни съюзи"]
    },
    "цитиране правила": {
        answer: "Подробни правила за цитиране:\n• Кавички за цитат („ “ или \" \")\n• Знаците за пунктуация остават в кавичките\n• Без струпване на знаци\n• При въпросителен/удивителен знак - точката след кавичките\n• Цитат в рамките на изречение - запазване на оригиналните знаци\n• Дълги цитати - отделяне в нов параграф",
        examples: ['„Мисля, следователно съществувам“.', '„Каква е тази идея?"', '„Невероятно!" - възкликна той.', 'Той каза: „Ще дойда утре."'],
        rules: ["Точката след кавички при въпросителен/удивителен знак", "Избягване на струпване на препинателни знаци", "Запазване на оригиналния текст", "Правилно поставяне на кавичките"]
    },
    "нравствен въпрос структура": {
        answer: "Структура на отговор на нравствен въпрос:\n• Въведение - представяне на темата и нравствения въпрос\n• Теза - ясно заявяване на позиция или мнение\n• Аргументи - логически доводи, примери от литературата, история, личен опит\n• Разглеждане на различни гледни точки\n• Заключение - обобщение и финално потвърждение на позицията\nКлючови елементи:\n• Яснота на изразяване\n• Логическа аргументация\n• Обективност\n• Етични принципи\n• Съпричастност",
        examples: ["Отговор на тема 'Защо трябва да помагаме на другите?'", "Разсъждение за справедливостта", "Мнение за честността в ежедневието"],
        rules: ["Яснота на изразяване", "Логическа аргументация", "Обективност", "Етични принципи", "Уважение към различните мнения"]
    },
    "преразказ техники": {
        answer: "Техники за преразказ:\n• Запазване на основния смисъл\n• Промяна на формата на изразяване\n• Използване на собствени думи\nВидове:\n• Подробен - запазва всички детайли\n• Подборен - фокус върху ключови моменти\n• Трансформиращ - промяна на гледна точка или време\nПравила:\n• Последователност на събитията\n• Запазване на хронологията\n• Обем: 15-20 изречения\n• Логични връзки между частите",
        examples: ["Преразказ на приказка", "Преразказ на разказ от различно лице", "Преразказ в сегашно време", "Преразказ с промяна на разказвача"],
        rules: ["Запазване на смисъла", "Употреба на собствени думи", "Последователност на събитията", "Съответствие на обема"]
    },
    "таблици работа": {
        answer: "Работа с таблици:\n• Елементи на таблицата:\n  - Заглавие\n  - Колони и редове\n  - Данни\n  - Заглавни клетки\n• Цел: организиране и ясно представяне на информация\n• Видове:\n  - Числови таблици\n  - Текстови таблици\n  - Комбинирани таблици\n  - Сравнителни таблици",
        examples: ["Таблица с успехи на ученици", "Таблица с исторически дати", "Таблица със сравнителни характеристики", "Таблица с граматични правила"],
        rules: ["Ясна организация", "Логично подреждане", "Точни данни", "Подходящи заглавия", "Четливо оформление"]
    },
    "есе структура": {
        answer: "Структура на есето:\n• Въведение - представяне на темата и тезата\n• Развитие - аргументи и примери\n• Заключение - обобщение и финална мисъл\nХарактеристики:\n• Логичност\n• Последователност\n• Убедителност\n• Яснота\n• Обоснованост",
        examples: ["Есе на тема 'Значението на образованието'", "Есе за влиянието на технологиите", "Есе за ролята на изкуството в живота"],
        rules: ["Ясна теза", "Логични аргументи", "Убедителни примери", "Обосновано заключение", "Свързаност между частите"]
    },
    "анализ на текст": {
        answer: "Стъпки за анализ на текст:\n1. Прочитане и първоначално впечатление\n2. Определяне на тема и основна мисъл\n3. Анализ на структурата\n4. Разглеждане на езиковите средства\n5. Анализ на стила и композицията\n6. Интерпретация и заключение\nАспекти за анализ:\n• Съдържание\n• Форма\n• Език и стил\n• Контекст\n• Авторска цел",
        examples: ["Анализ на разказ", "Анализ на стихотворение", "Анализ на публицистичен текст", "Анализ на драматично произведение"],
        rules: ["Системен подход", "Подкрепяне с цитати", "Логични заключения", "Обективност", "Цялостно разбиране"]
    },
    "матура подготовка": {
        answer: "Цялостна подготовка за матура по български език:\n1. Четене с разбиране (30-40 мин):\n   - Два пъти прочитане\n   - Подчертаване на ключови думи\n   - Определяне на основна мисъл\n2. Граматика (20-30 мин):\n   - Правопис и пунктуация\n   - Морфологичен анализ\n   - Синтактичен анализ\n3. Литература (30-40 мин):\n   - Анализ на литературни текстове\n   - Характеристика на герои\n   - Определяне на теми и идеи\n4. Писане (40-50 мин):\n   - Есе, разсъждение, преразказ\n   - Планиране на текста\n   - Проверка на граматиката\nСтратегии:\n• Управление на времето\n• Преглед на всички задачи\n• Проверка на отговорите",
        examples: ["Матурен тест от предни години", "Упражнения по граматика", "Анализ на литературни текстове", "Писане на есета"],
        rules: ["Времеразпределение", "Преглед на задачите", "Проверка на отговорите", "Спокойствие и концентрация"]
    }
  };

  const messages = [
      { sender: 'ai', text: 'Здравей! Аз съм BAI Ганьо, твоят AI помощник по български език и литература. Как мога да ти помогна днес?' }
  ];

  function renderMessages() {
      if (!chat) return;
      chat.innerHTML = '';
      messages.forEach(msg => {
          const div = document.createElement('div');
          div.classList.add('message', msg.sender);

          if (msg.sender === 'ai' && msg.formatted) {
              div.classList.add('formatted-message');
              div.innerHTML = msg.text;
          } else {
              div.textContent = msg.text;
          }

          chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
  }

  function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.classList.add('typing-indicator');
      typingDiv.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
      `;
      chat.appendChild(typingDiv);
      chat.scrollTop = chat.scrollHeight;
      return typingDiv;
  }

  function hideTypingIndicator(typingElement) {
      if (typingElement && typingElement.parentNode) {
          typingElement.remove();
      }
  }

  function formatAnswer(answer, examples, rules) {
      let formatted = `<p>${answer.replace(/\n/g, '</p><p>')}</p>`;
      
      if (examples && examples.length > 0) {
          formatted += `<p><strong>Примери:</strong></p><ul>`;
          examples.forEach(ex => {
              formatted += `<li>${ex}</li>`;
          });
          formatted += `</ul>`;
      }
      
      if (rules && rules.length > 0) {
          formatted += `<p><strong>Правила:</strong></p><ul>`;
          rules.forEach(rule => {
              formatted += `<li>${rule}</li>`;
          });
          formatted += `</ul>`;
      }
      
      return formatted;
  }

  function containsEnglish(text) {
      return /[a-zA-Z]/.test(text);
  }

  function findBestAnswer(userText) {
    const lower = userText.toLowerCase();
    
    if (lower.includes('масова комуникация') || lower.includes('медии') || lower.includes('медиен текст')) {
        return {
            text: formatAnswer(
                knowledgeBase["масова комуникация"].answer,
                knowledgeBase["масова комуникация"].examples,
                knowledgeBase["масова комуникация"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('информационна бележка') || lower.includes('информационен текст') || lower.includes('бележка')) {
        return {
            text: formatAnswer(
                knowledgeBase["информационна бележка"].answer,
                knowledgeBase["информационна бележка"].examples,
                knowledgeBase["информационна бележка"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('репортаж') || lower.includes('репортьор') || lower.includes('репортажен')) {
        return {
            text: formatAnswer(
                knowledgeBase["репортаж детайли"].answer,
                knowledgeBase["репортаж детайли"].examples,
                knowledgeBase["репортаж детайли"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('интервю') || lower.includes('интервюирам') || lower.includes('интервюта')) {
        return {
            text: formatAnswer(
                knowledgeBase["интервю техники"].answer,
                knowledgeBase["интервю техники"].examples,
                knowledgeBase["интервю техники"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('художествен текст') || lower.includes('художествена литература') || lower.includes('художествено произведение')) {
        return {
            text: formatAnswer(
                knowledgeBase["художествен текст елементи"].answer,
                knowledgeBase["художествен текст елементи"].examples,
                knowledgeBase["художествен текст елементи"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('лексикални средства') || lower.includes('лексика') || lower.includes('речников състав') || lower.includes('думата като')) {
        return {
            text: formatAnswer(
                knowledgeBase["лексикални средства"].answer,
                knowledgeBase["лексикални средства"].examples,
                knowledgeBase["лексикални средства"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('звукови промени') || lower.includes('подвижно ъ') || lower.includes('непостоянно ъ') || lower.includes('променливо я')) {
        return {
            text: formatAnswer(
                knowledgeBase["звукови промени"].answer,
                knowledgeBase["звукови промени"].examples,
                knowledgeBase["звукови промени"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('наклонение') || lower.includes('изявително') || lower.includes('условно') || lower.includes('повелително')) {
        return {
            text: formatAnswer(
                knowledgeBase["глаголни наклонения"].answer,
                knowledgeBase["глаголни наклонения"].examples,
                knowledgeBase["глаголни наклонения"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('преизказни форми') || lower.includes('преизказвам') || lower.includes('чуто не видяно') || lower.includes('преизказни глаголни')) {
        return {
            text: formatAnswer(
                knowledgeBase["преизказни форми"].answer,
                knowledgeBase["преизказни форми"].examples,
                knowledgeBase["преизказни форми"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('глаголни времена') || lower.includes('време на глагола') || lower.includes('минало време') || lower.includes('бъдеще време')) {
        return {
            text: formatAnswer(
                knowledgeBase["глаголни времена система"].answer,
                knowledgeBase["глаголни времена система"].examples,
                knowledgeBase["глаголни времена система"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('съставно сказуемо') || lower.includes('именно сказуемо') || lower.includes('глаголно сказуемо') || lower.includes('сказуемо')) {
        return {
            text: formatAnswer(
                knowledgeBase["съставно сказуемо"].answer,
                knowledgeBase["съставно сказуемо"].examples,
                knowledgeBase["съставно сказуемо"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('обособени части') || lower.includes('обособено определение') || lower.includes('обособено пояснение') || lower.includes('обособявам')) {
        return {
            text: formatAnswer(
                knowledgeBase["обособени части"].answer,
                knowledgeBase["обособени части"].examples,
                knowledgeBase["обособени части"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('сложни изречения') || lower.includes('сложно съчинено') || lower.includes('сложно подчинено') || lower.includes('сложно смесено')) {
        return {
            text: formatAnswer(
                knowledgeBase["сложни изречения типове"].answer,
                knowledgeBase["сложни изречения типове"].examples,
                knowledgeBase["сложни изречения типове"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('чужда реч') || lower.includes('пряка реч') || lower.includes('непряка реч') || lower.includes('полупряка реч')) {
        return {
            text: formatAnswer(
                knowledgeBase["чужда реч форми"].answer,
                knowledgeBase["чужда реч форми"].examples,
                knowledgeBase["чужда реч форми"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('цитиране') || lower.includes('цитат') || lower.includes('кавички') || lower.includes('предаване на цитат')) {
        return {
            text: formatAnswer(
                knowledgeBase["цитиране правила"].answer,
                knowledgeBase["цитиране правила"].examples,
                knowledgeBase["цитиране правила"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('нравствен въпрос') || lower.includes('нравствена тема') || lower.includes('морален въпрос') || lower.includes('нравствено разсъждение')) {
        return {
            text: formatAnswer(
                knowledgeBase["нравствен въпрос структура"].answer,
                knowledgeBase["нравствен въпрос структура"].examples,
                knowledgeBase["нравствен въпрос структура"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('преразказ') || lower.includes('преразказвам') || lower.includes('преразкажи')) {
        return {
            text: formatAnswer(
                knowledgeBase["преразказ техники"].answer,
                knowledgeBase["преразказ техники"].examples,
                knowledgeBase["преразказ техники"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('таблици') || lower.includes('таблица') || lower.includes('табличен') || lower.includes('работа с таблици')) {
        return {
            text: formatAnswer(
                knowledgeBase["таблици работа"].answer,
                knowledgeBase["таблици работа"].examples,
                knowledgeBase["таблици работа"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('есе') || lower.includes('съчинение') || lower.includes('есе структура')) {
        return {
            text: formatAnswer(
                knowledgeBase["есе структура"].answer,
                knowledgeBase["есе структура"].examples,
                knowledgeBase["есе структура"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('анализ на текст') || lower.includes('анализирам текст') || lower.includes('текстов анализ')) {
        return {
            text: formatAnswer(
                knowledgeBase["анализ на текст"].answer,
                knowledgeBase["анализ на текст"].examples,
                knowledgeBase["анализ на текст"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('матура') || lower.includes('подготовка за матура') || lower.includes('матурен изпит')) {
        return {
            text: formatAnswer(
                knowledgeBase["матура подготовка"].answer,
                knowledgeBase["матура подготовка"].examples,
                knowledgeBase["матура подготовка"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('опълченци') || lower.includes('шипка')) {
        return {
            text: formatAnswer(
                knowledgeBase["опълченците на шипка"].answer,
                knowledgeBase["опълченците на шипка"].quotes
            ),
            formatted: true
        };
    }

    if (lower.includes('жица') || lower.includes('моканин') || lower.includes('негованка')) {
        return {
            text: formatAnswer(
                knowledgeBase["по жицата"].answer,
                knowledgeBase["по жицата"].examples,
                knowledgeBase["по жицата"].themes
            ),
            formatted: true
        };
    }

    if (lower.includes('серафим') || lower.includes('йовков')) {
        return {
            text: formatAnswer(
                knowledgeBase["серафим"].answer,
                null,
                knowledgeBase["серафим"].themes
            ),
            formatted: true
        };
    }

    if (lower.includes('една българка') || lower.includes('баба илийца')) {
        return {
            text: formatAnswer(
                knowledgeBase["една българка"].answer,
                knowledgeBase["една българка"].quotes,
                knowledgeBase["една българка"].themes
            ),
            formatted: true
        };
    }

    if (lower.includes('неразделни') || lower.includes('дора габе')) {
        return {
            text: formatAnswer(
                knowledgeBase["неразделни"].answer,
                knowledgeBase["неразделни"].quotes,
                knowledgeBase["неразделни"].themes
            ),
            formatted: true
        };
    }

    if (lower.includes('до чикаго')) {
        return {
            text: formatAnswer(
                knowledgeBase["до чикаго и назад"].answer,
                knowledgeBase["до чикаго и назад"].examples,
                knowledgeBase["до чикаго и назад"].themes
            ),
            formatted: true
        };
    }

    if (lower.includes('бъдеще в миналото') || lower.includes('щеше да')) {
        return {
            text: formatAnswer(
                knowledgeBase["глаголни времена"].answer,
                knowledgeBase["глаголни времена"].examples,
                knowledgeBase["глаголни времена"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('деепричастие') || lower.includes('причастие')) {
        return {
            text: formatAnswer(
                knowledgeBase["причастия"].answer,
                knowledgeBase["причастия"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('сложно изреч') || lower.includes('подчинено изреч')) {
        return {
            text: formatAnswer(
                knowledgeBase["сложни изречения"].answer,
                knowledgeBase["сложни изречения"].examples,
                knowledgeBase["сложни изречения"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('морфем') || lower.includes('морфологич')) {
        return {
            text: formatAnswer(
                knowledgeBase["морфеми"].answer,
                knowledgeBase["морфеми"].examples
            ),
            formatted: true
        };
    }
    
    if (lower.includes('глагол') || lower.includes('времена') || lower.includes('спрежен')) {
        return {
            text: formatAnswer(
                knowledgeBase["глаголни времена"].answer,
                null,
                knowledgeBase["глаголни времена"].rules
            ),
            formatted: true
        };
    }
    
    if (lower.includes('съществително') || lower.includes('име съществително')) {
        return {
            text: formatAnswer(
                knowledgeBase["съществително име"].answer,
                knowledgeBase["съществително име"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('прилагателно') || lower.includes('име прилагателно')) {
        return {
            text: formatAnswer(
                knowledgeBase["прилагателно име"].answer,
                knowledgeBase["прилагателно име"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('числително') || lower.includes('име числително')) {
        return {
            text: formatAnswer(
                knowledgeBase["числително име"].answer,
                knowledgeBase["числително име"].examples
            ),
            formatted: true
        };
    }

     if (lower.includes('преразказ') || lower.includes('преразкажете')) {
        return {
            text: formatAnswer(
                knowledgeBase["преразказ"].answer,
                knowledgeBase["преразказ"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('матура') || lower.includes('съвет') || lower.includes('стратеги')) {
        return {
            text: formatAnswer(
                knowledgeBase["матура съвети"].answer,
                null,
                knowledgeBase["матура съвети"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('местоим') || lower.includes('местоимен')) {
        return {
            text: formatAnswer(
                knowledgeBase["местоимения"].answer,
                null,
                knowledgeBase["местоимения"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('причасти') || lower.includes('деепричасти')) {
        return {
            text: formatAnswer(
                knowledgeBase["причастия"].answer,
                null,
                knowledgeBase["причастия"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('наречие')) {
        return {
            text: formatAnswer(
                knowledgeBase["наречие"].answer,
                knowledgeBase["наречие"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('предлог')) {
        return {
            text: formatAnswer(
                knowledgeBase["предлог"].answer,
                knowledgeBase["предлог"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('съюз')) {
        return {
            text: formatAnswer(
                knowledgeBase["съюз"].answer,
                knowledgeBase["съюз"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('частица') && !lower.includes('не')) {
        return {
            text: formatAnswer(
                knowledgeBase["частица"].answer,
                knowledgeBase["частица"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('междуметие')) {
        return {
            text: formatAnswer(
                knowledgeBase["междуметие"].answer,
                knowledgeBase["междуметие"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('чужда реч') || lower.includes('пряка реч')) {
        return {
            text: formatAnswer(
                knowledgeBase["чужда реч"].answer,
                null,
                knowledgeBase["чужда реч"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('сложно изреч') || lower.includes('съчинено изреч') || lower.includes('подчинено изреч')) {
        return {
            text: formatAnswer(
                knowledgeBase["сложно изречение"].answer,
                knowledgeBase["сложно изречение"].examples
            ),
            formatted: true
        };
    }
    
    if (lower.includes('хайдут') || lower.includes('ботев')) {
        return {
            text: formatAnswer(
                knowledgeBase["хайдути"].answer,
                knowledgeBase["хайдути"].quotes
            ),
            formatted: true
        };
    }
    
    if (lower.includes('бай ган') || lower.includes('алеко константинов')) {
        return {
            text: formatAnswer(
                knowledgeBase["бай ганьо"].answer,
                knowledgeBase["бай ганьо"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('приказк') || lower.includes('фолклор')) {
        return {
            text: formatAnswer(
                knowledgeBase["приказки"].answer,
                knowledgeBase["приказки"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('стихотворен размер') || lower.includes('стихотворни размери')) {
        return {
            text: formatAnswer(
                knowledgeBase["стихотворни размери"].answer,
                null,
                knowledgeBase["стихотворни размери"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('анализ на стихотворен') || lower.includes('стихотворен анализ')) {
        return {
            text: formatAnswer(
                knowledgeBase["анализ на стихотворение"].answer,
                knowledgeBase["анализ на стихотворение"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('епическ') || lower.includes('роман') || lower.includes('повест')) {
        return {
            text: formatAnswer(
                knowledgeBase["епически произведения"].answer,
                knowledgeBase["епически произведения"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('драма') || lower.includes('драматичн')) {
        return {
            text: formatAnswer(
                knowledgeBase["драматични произведения"].answer,
                knowledgeBase["драматични произведения"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('лирическ') || lower.includes('стихотворен')) {
        return {
            text: formatAnswer(
                knowledgeBase["лирически произведения"].answer,
                knowledgeBase["лирически произведения"].examples
            ),
            formatted: true
        };
    }
    
    if (lower.includes('описан') || lower.includes('описвам')) {
        return {
            text: formatAnswer(
                knowledgeBase["описание"].answer,
                knowledgeBase["описание"].examples
            ),
            formatted: true
        };
    }
    
    if (lower.includes('повествован') || lower.includes('разказвам')) {
        return {
            text: formatAnswer(
                knowledgeBase["повествование"].answer,
                null,
                knowledgeBase["повествование"].rules
            ),
            formatted: true
        };
    }
    
    if (lower.includes('разсъжден') || lower.includes('разсъждавам')) {
        return {
            text: formatAnswer(
                knowledgeBase["разсъждение"].answer,
                knowledgeBase["разсъждение"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('преразказ') || lower.includes('преразказвам')) {
        return {
            text: formatAnswer(
                knowledgeBase["преразказ"].answer,
                null,
                knowledgeBase["преразказ"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('анотац') || lower.includes('реферат')) {
        return {
            text: formatAnswer(
                knowledgeBase["анотация"].answer,
                knowledgeBase["анотация"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('есе') || lower.includes('съчинение разсъждение')) {
        return {
            text: formatAnswer(
                knowledgeBase["есе структура"].answer,
                null,
                knowledgeBase["есе структура"].rules
            ),
            formatted: true
        };
    }

    if (lower.includes('интервю')) {
        return {
            text: formatAnswer(
                knowledgeBase["интервю"].answer,
                knowledgeBase["интервю"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('репортаж') || lower.includes('репортьор')) {
        return {
            text: formatAnswer(
                knowledgeBase["репортаж"].answer,
                null,
                knowledgeBase["репортаж"].themes
            ),
            formatted: true
        };
    }
    
    if (lower.includes('изречен') || lower.includes('части на изречението')) {
        return {
            text: formatAnswer(
                knowledgeBase["изречение"].answer,
                knowledgeBase["изречение"].examples
            ),
            formatted: true
        };
    }

    if (lower.includes('немили') || lower.includes('недраги')) {
      return {
        text: formatAnswer(
          knowledgeBase["немили-недраги"].answer,
          null,
          knowledgeBase["немили-недраги"].themes
        ),
        formatted: true
      };
    }
    
    if (lower.includes('под игото') || lower.includes('игото')) {
      return {
        text: formatAnswer(
          knowledgeBase["под игото"].answer,
          knowledgeBase["под игото"].quotes
        ),
        formatted: true
      };
    }
    
    if (lower.includes('вятър ечи') || lower.includes('балкан стене')) {
      return {
        text: formatAnswer(
          knowledgeBase["вятър ечи, балкан стене"].answer,
          knowledgeBase["вятър ечи, балкан стене"].quotes
        ),
        formatted: true
      };
    }
    
    if (lower.includes('заточеници') || lower.includes('вазов заточеници')) {
      return {
        text: formatAnswer(
          knowledgeBase["заточеници"].answer,
          knowledgeBase["заточеници"].quotes
        ),
        formatted: true
      };
    }
    
    if (lower.includes('народни песни') || lower.includes('фолклорни песни')) {
      return {
        text: formatAnswer(
          knowledgeBase["народни песни"].answer,
          knowledgeBase["народни песни"].examples
        ),
        formatted: true
      };
    }
      
    if (lower.includes('правопис') || lower.includes('правописн')) {
        return { 
            text: 'В българския език има много правописни правила. За кое конкретно правило искаш да научиш? Например:\n- Правопис на "не"\n- Употреба на "ъ" и "ь"\n- Глаголни окончания\n- Главни и малки букви',
            formatted: false
        };
    }
      
    if (lower.includes('литература') || lower.includes('книг') || lower.includes('произведени')) {
        return { 
            text: 'Българската литература е богата и разнообразна! За кое произведение или автор искаш да научиш повече? Например:\n- "Под игото" на Иван Вазов\n- "Хайдути" на Христо Ботев\n- "Бай Ганьо" на Алеко Константинов\n- "Грозното патенце" на Андерсен',
            formatted: false
        };
    }
      
    if (lower.includes('тест') || lower.includes('упражнен')) {
        return { 
            text: 'Искаш ли да направим упражнение? Мога да ти задам въпроси по:\n1. Правопис\n2. Граматика\n3. Литературни произведения\n4. Автори и творби\nИзбери тема и започваме!',
            formatted: false
        };
    }
      
    if (lower.includes('консултация') || lower.includes('учител')) {
        return { 
            text: 'Ако имаш трудности с някоя тема, наистина е добра идея да потърсиш помощ от учителя си. Мога да ти помогна с:\n- Обяснение на трудни теми\n- Примери и правила\n- Подготовка за изпит\nНо за персонализирана помощ учителят е най-добрият избор!',
            formatted: false
        };
    }
      
    const randomResponses = [
        "Интересен въпрос! Можеш ли да го зададеш по-конкретно?",
        "Все още се уча, но ще се опитам да помогна. За коя точно тема питаш?",
        "Имам информация за много теми от български език и литература. Опитай да питаш за конкретно произведение, правило или понятие.",
        "Попитай ме за конкретно правило, произведение или автор и ще ти помогна!"
    ];
    return { 
        text: randomResponses[Math.floor(Math.random() * randomResponses.length)],
        formatted: false
    };
}

  chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      handleUserInput();
  });

  chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleUserInput();
      }
  });

  function handleUserInput() {
      const userText = chatInput.value.trim();
      if (!userText) return;
      
      if (containsEnglish(userText)) {
          const ganioPhrases = [
              "Абе, момко, тука да не ти е Америка?! Пиши на кирилица, че ме хваща срама!",
              "Ганьо не говори на английски! Кирилица, или ще те върна в трети клас!",
              "Като видя латиница и ми пресъхва ракията! Пиши както баба ти те е учила!",
              "Това да не ти е чат с Макдоналдс?! Тука кирилицата е задължителна, момко!",
              "На мен ми дай 'ъ', 'щ', 'ш'... другото го прати на някой Гугъл Транслейт!",
              "Момко, ако не видя една 'а' и една 'ъ' в изречението, нема повече да ти отговарям!"
          ];
          const randomGanioMsg = ganioPhrases[Math.floor(Math.random() * ganioPhrases.length)];
          messages.push({ sender: 'user', text: userText });
          messages.push({ sender: 'ai', text: randomGanioMsg, formatted: false });
          renderMessages();
          chatInput.value = '';
          return;
      }
      
      messages.push({ sender: 'user', text: userText });
      renderMessages();
      chatInput.value = '';
      
      const typingElement = showTypingIndicator();
      
      setTimeout(() => {
          hideTypingIndicator(typingElement);
          
          const aiResponse = findBestAnswer(userText);
          messages.push({ 
              sender: 'ai', 
              text: aiResponse.text,
              formatted: aiResponse.formatted
          });
          renderMessages();
      }, 1500);
  }

  quickQuestions.forEach(button => {
      button.addEventListener('click', function() {
          const question = this.textContent;
          chatInput.value = question;
          chatForm.dispatchEvent(new Event('submit'));
      });
  });

  renderMessages();
});